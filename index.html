<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Covalex Logistics - Gateway Update (V34)</title>
    <style>
        :root {
            --sc-blue: #00d8ff;
            --sc-dark: #0b1116;
            --sc-panel: #162028;
            --sc-text: #a8dcea;
            --sc-alert: #ff4d4d;
            --sc-success: #69ff4d;
            --sc-warning: #ffcc00;
            --sc-fuel: #ff9900;
            --sc-money: #00ff9d;
        }

        body {
            background-color: var(--sc-dark);
            color: var(--sc-text);
            font-family: 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            padding-bottom: 60px;
            background-image: radial-gradient(circle at 50% 50%, #1a2a35 0%, #0b1116 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        h1, h2, h3, h4 {
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--sc-blue);
            text-shadow: 0 0 10px rgba(0, 216, 255, 0.3);
            margin-top: 0;
        }

        /* HEADER & LOGO */
        .brand-header { display: flex; align-items: center; gap: 20px; }
        .covalex-logo {
            width: 250px; height: 250px;
            filter: drop-shadow(0 0 8px var(--sc-blue));
        }
        .cls-1 { fill: var(--sc-blue); } 
        .cls-2 { fill: #fff; }

        /* MANUAL DRAWER */
        #manualTab {
            position: fixed; top: 100px; right: 0;
            background: var(--sc-blue); color: var(--sc-dark);
            padding: 15px 10px; font-weight: bold; cursor: pointer;
            writing-mode: vertical-rl; text-orientation: mixed;
            border-top-left-radius: 10px; border-bottom-left-radius: 10px;
            box-shadow: -2px 2px 10px rgba(0,0,0,0.5); z-index: 2000;
            transition: right 0.3s ease;
        }
        #manualDrawer {
            position: fixed; top: 0; right: -80%; width: 75%; height: 100%;
            background: #0f161c; border-left: 2px solid var(--sc-blue);
            box-shadow: -10px 0 30px rgba(0,0,0,0.8); z-index: 1999;
            transition: right 0.3s ease; overflow-y: auto; padding: 40px; box-sizing: border-box;
        }
        #manualDrawer.active { right: 0; }
        #manualTab.active { right: 75%; background: var(--sc-alert); color: #000; }
        .manual-content h2 { border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 30px; color: #fff; }
        .manual-content h3 { color: var(--sc-blue); margin-top: 20px; }
        .manual-content ul { line-height: 1.6; color: #ccc; }
        .manual-content code { background: #222; padding: 2px 6px; border-radius: 3px; color: var(--sc-warning); }
        .manual-content blockquote { border-left: 4px solid var(--sc-blue); margin: 20px 0; padding-left: 15px; color: #888; font-style: italic; }

        /* FOOTER */
        footer {
            margin-top: 50px; border-top: 1px solid #333; padding-top: 20px;
            color: #555; font-size: 0.7rem; text-align: center; width: 100%;
        }

        /* Layout Grid */
        .container { display: grid; grid-template-columns: 380px 1fr; gap: 20px; max-width: 1600px; margin: 0 auto; }

        /* Panels */
        .panel {
            background: var(--sc-panel); border: 1px solid rgba(0, 216, 255, 0.2);
            padding: 20px; border-radius: 4px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px; position: relative;
        }
        .panel::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--sc-blue), transparent);
        }

        /* Inputs */
        input, select, textarea {
            width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid #2c4250;
            color: #fff; padding: 8px; margin-bottom: 5px; box-sizing: border-box; font-family: monospace;
        }
        textarea { resize: vertical; min-height: 60px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--sc-blue); }
        optgroup { background: #2c4250; color: var(--sc-blue); font-weight: bold; }
        option { background: #162028; color: white; padding: 5px; }

        label { font-size: 0.75rem; color: var(--sc-blue); text-transform: uppercase; display: block; margin-top: 10px; margin-bottom: 4px; }

        /* Dynamic Rows */
        .dynamic-row-complex { background: rgba(255, 255, 255, 0.03); border: 1px solid #333; margin-bottom: 8px; padding: 5px; border-left: 2px solid var(--sc-blue); }
        .drc-top { margin-bottom: 2px; }
        .drc-bot { display: flex; gap: 5px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; margin-bottom: 10px; padding-bottom: 5px; }

        /* Buttons */
        .btn { background: rgba(0, 216, 255, 0.1); border: 1px solid var(--sc-blue); color: var(--sc-blue); padding: 10px; cursor: pointer; text-transform: uppercase; font-weight: bold; transition: all 0.2s; width: 100%; margin-top: 10px; }
        .btn:hover { background: var(--sc-blue); color: var(--sc-dark); box-shadow: 0 0 15px var(--sc-blue); }
        .btn-calc { background: rgba(105, 255, 77, 0.1); border-color: var(--sc-success); color: var(--sc-success); }
        .btn-calc:hover { background: var(--sc-success); color: #000; box-shadow: 0 0 15px var(--sc-success); }
        .btn-add { background: none; border: 1px dashed #444; color: #888; font-size: 0.8rem; padding: 4px 10px; width: auto; cursor: pointer; margin: 0; }
        .btn-add:hover { border-color: var(--sc-blue); color: var(--sc-blue); background: rgba(0, 216, 255, 0.05); }
        .btn-del { background: none; border: 1px solid var(--sc-alert); color: var(--sc-alert); width: 30px; padding: 0; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-del:hover { background: var(--sc-alert); color: black; }
        .btn-log { background: none; border: 1px solid var(--sc-warning); color: var(--sc-warning); padding: 2px 8px; font-size: 0.7rem; cursor: pointer; width: auto; margin:0; }
        .btn-log:hover { background: var(--sc-warning); color: black; }
        .btn-complete { background: transparent; border: 1px solid var(--sc-success); color: var(--sc-success); padding: 2px 10px; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; }
        .btn-complete:hover { background: var(--sc-success); color:black; }

        /* Dashboard Visuals */
        .capacity-bar-container { height: 15px; background: #000; border: 1px solid #333; width: 100%; position: relative; margin: 5px 0 15px 0; }
        .capacity-bar { height: 100%; background: var(--sc-blue); width: 0%; transition: width 0.5s ease; box-shadow: 0 0 10px var(--sc-blue); }
        .fuel-bar { background: var(--sc-fuel); box-shadow: 0 0 10px var(--sc-fuel); }
        .capacity-bar.overload { background: var(--sc-alert); box-shadow: 0 0 10px var(--sc-alert); }

        /* Contract Card */
        .contract-card { background: rgba(255, 255, 255, 0.05); border-left: 3px solid var(--sc-blue); padding: 12px; margin-bottom: 10px; display: grid; grid-template-columns: 1fr auto; font-size: 0.9rem; position: relative; }
        .comm-pill { display:inline-block; background:rgba(0,216,255,0.15); padding:2px 6px; border-radius:3px; margin:2px; font-size:0.75rem; border:1px solid rgba(0,216,255,0.3); }

        /* Drawers & Logs */
        .feedback-drawer { grid-column: 1 / -1; background: #111; border-top: 1px dashed #444; margin-top: 10px; padding: 10px; display: none; }
        .check-group { display: flex; gap: 10px; margin-bottom: 5px; flex-wrap: wrap; }
        .check-item { display: flex; align-items: center; gap: 5px; font-size: 0.8rem; color: #ccc; cursor: pointer; background:#222; padding:2px 6px; border-radius:3px; border:1px solid #333; }
        .timeline-step { position: relative; padding-left: 30px; margin-bottom: 20px; border-left: 2px solid #333; }
        .timeline-step::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; border-radius: 50%; background: var(--sc-blue); box-shadow: 0 0 8px var(--sc-blue); }
        .step-location { font-size: 1.1rem; font-weight: bold; color: #fff; margin-bottom: 5px; display:flex; justify-content:space-between; align-items:center; }
        .step-distance { font-size: 0.8rem; color: #666; margin-bottom: 10px; font-style: italic; display: flex; gap: 10px; }
        .stat-badge { background: #222; padding:2px 6px; border-radius:4px; border:1px solid #444; color:#aaa; }
        .badge-verified { border-color: var(--sc-success); color: var(--sc-success); }
        .badge-estimate { border-color: var(--sc-warning); color: var(--sc-warning); }
        .step-action { background: rgba(255,255,255,0.05); padding: 8px; margin-bottom: 4px; border-radius: 3px; display: flex; justify-content: space-between; }
        .step-refuel { background: rgba(255, 153, 0, 0.1); border: 1px dashed var(--sc-fuel); color: var(--sc-fuel); font-weight: bold; padding: 8px; margin-bottom: 4px; border-radius: 3px; }
        .step-ship-load { font-size: 0.8rem; color: #888; margin-top: 5px; display:flex; justify-content:space-between; }

        .eng-stat-row { display:flex; justify-content: space-between; font-size:0.8rem; border-bottom:1px solid #333; padding:5px 0; }
        .eng-val { color: var(--sc-blue); font-family:monospace; }
        .log-table { width:100%; border-collapse: collapse; font-size:0.8rem; }
        .log-table th { text-align:left; color:var(--sc-blue); border-bottom:1px solid #555; }
        .log-table td { padding: 5px 0; border-bottom:1px solid #333; color:#ccc; }
        #statusLog { margin-top: 10px; font-size: 0.8rem; color: var(--sc-alert); min-height: 20px; }
        .hidden-input { display:none; border-color: var(--sc-warning); }
        #commodityListContainer { background: rgba(0,0,0,0.2); border: 1px solid #333; padding: 5px; min-height: 40px; margin-bottom: 10px; }
        .comm-item { display:flex; justify-content:space-between; align-items:center; background:#222; margin-bottom:2px; padding:2px 5px; font-size:0.8rem; }
        .comm-del-x { color:var(--sc-alert); cursor:pointer; font-weight:bold; margin-left:5px; }
        .fuel-input-row { display: flex; gap: 10px; margin-top: 5px; align-items: center; background: #111; padding: 5px; border: 1px solid #333; }
        .fuel-input-row input { height: 25px; margin: 0; border: 1px solid var(--sc-fuel); color: var(--sc-fuel); width: 80px; }

        .contract-name-builder { display:flex; flex-direction:column; gap:5px; background:rgba(255,255,255,0.05); padding:10px; border:1px solid #444; margin-bottom:10px; }
        .cnb-row { display:flex; gap:5px; }
    </style>
</head>
<body>

    <div id="manualTab" onclick="toggleManual()">üìò MANUAL</div>
    <div id="manualDrawer">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h1>OPERATIONS MANUAL <span style="font-size:0.5em; color:white; opacity:0.5;">// V34.0</span></h1>
            <button class="btn btn-del" style="width:auto; height:30px; padding:0 10px;" onclick="toggleManual()">CLOSE X</button>
        </div>
        <div class="manual-content">
            <p>Welcome to the Covalex Logistics Companion. This tool helps Hull C operators plan routes, manage cargo loads, and track fuel efficiency.</p>
            <h2>1. Initial Setup</h2>
            <ul>
                <li><strong>Vessel Config:</strong> Select <code>4608 SCU</code> for standard runs or <code>2880 SCU</code> for safe config.</li>
                <li><strong>Drive Calibration:</strong> Select your Quantum Drive (e.g., <code>Kama</code>, <code>TS-2</code>).</li>
                <li><strong>Starting State:</strong> Select your parked location. Switch to <strong>NAV Mode</strong> in-game and enter the Fuel Reading (e.g., <code>8.60</code>).</li>
            </ul>
            <h2>2. Adding Contracts</h2>
            <ul>
                <li><strong>Name:</strong> Type the name manually OR use the "Autofill Template" dropdown to paste a template.</li>
                <li><strong>Pickups/Drops:</strong> Add each location line item individually with its specific commodity.</li>
                <li>Click <code>ADD TO MANIFEST</code>. The itinerary will auto-calculate based on your current location.</li>
            </ul>
            <h2>3. Execution</h2>
            <ul>
                <li>Follow the <strong>Itinerary</strong>. Stops are optimized to minimize travel.</li>
                <li><strong>Completing Legs:</strong> When you arrive, enter your actual Fuel Reading and click <code>COMPLETE LEG</code> to calibrate the system.</li>
            </ul>
        </div>
    </div>

    <header>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="brand-header">
                <svg class="covalex-logo" xmlns="http://www.w3.org/2000/svg" id="Layer_1" data-name="Layer 1" viewBox="0 0 800 600">
                    <defs><style>.cls-1{fill:var(--sc-blue);}.cls-2{fill:#fff;}</style></defs>
                    <path d="M449.52 150h-99.04l-58.16 88.82 58.16 88.81h99.04l58.16-88.81L449.52 150z" class="cls-2"/>
                    <path d="M432.91 296.91H367.1l-38.05-58.09 38.05-58.09h65.81l11.03-20.41h-87.88l-51.4 78.5 51.4 78.49h87.88l-11.03-20.4z" class="cls-1"/>
                    <path d="M376.31 285.01h50.72l29.14-44.49h-50.73l-29.13 44.49zM373.16 194.03l-29.33 44.79 29.33 44.78 29.33-44.78-29.33-44.79zM405.44 237.12h50.73l-29.14-44.49h-50.72l29.13 44.49z" class="cls-1"/>
                    <path d="M197.24 412.38h-58.49c-4.66 0-8.65-1.65-11.95-4.96-3.3-3.3-4.96-7.29-4.96-11.95v-19.82c0-4.66 1.65-8.64 4.96-11.95 3.3-3.3 7.28-4.96 11.95-4.96h58.49v13.99h-61.4v25.65h61.4v13.99ZM264.86 372.74h-47.41v25.65h47.41v-25.65Zm13.99 22.73c0 4.66-1.65 8.64-4.96 11.95-3.3 3.31-7.29 4.96-11.95 4.96h-41.58c-4.66 0-8.65-1.65-11.95-4.96-3.3-3.3-4.96-7.29-4.96-11.95v-19.82c0-4.66 1.65-8.64 4.96-11.95s7.29-4.96 11.95-4.96h41.58c4.66 0 8.64 1.65 11.95 4.96 3.3 3.3 4.96 7.29 4.96 11.95v19.82ZM374.74 358.75l-35.75 47.9c-3.43 4.6-7.48 6.89-12.15 6.89s-8.81-2.3-12.24-6.89l-35.75-47.9h17.78l30.21 41.39 30.12-41.39h17.78ZM439.15 412.38h-17.78l-7.58-10.3h-39.35l10.2-13.99h18.95l-12.44-17.1-30.12 41.39h-17.78L379 364.49c3.43-4.6 7.51-6.9 12.24-6.9s8.71 2.3 12.15 6.9l35.75 47.89ZM500.55 412.38h-44.49c-4.66 0-8.65-1.65-11.95-4.96-3.3-3.3-4.95-7.29-4.95-11.95v-36.72h13.99v39.64h47.41v13.99ZM580.61 392.56h-56.74v-13.99h56.74v13.99Zm0 19.82h-58.49c-4.66 0-8.65-1.65-11.95-4.96-3.31-3.3-4.96-7.29-4.96-11.95v-19.82c0-4.66 1.65-8.64 4.96-11.95 3.3-3.3 7.28-4.96 11.95-4.96h58.49v13.99h-61.4v25.65h61.4v13.99ZM678.15 412.38h-23.03l-20.31-16.03c-2.33-1.81-3.98-4.01-4.95-6.6-.91 2.59-2.53 4.79-4.86 6.6l-20.3 16.03h-23.03l34.68-27.01-34.2-26.62h23.03l19.92 15.64c2.27 1.81 3.85 3.99 4.76 6.51.97-2.53 2.59-4.7 4.86-6.51l19.92-15.64h23.02l-34.19 26.62 34.68 27.01Z" class="cls-1"/>
                    <path d="M146.29 449.64H122.9v-3.88h25.57v-5.34h-20.56c-3.36 0-6.07-2.71-6.07-6.06v-.97c0-3.36 2.71-6.06 6.07-6.06h23.39v3.88h-25.57v5.34h20.56c3.36 0 6.07 2.71 6.07 6.06v.97c0 3.36-2.71 6.06-6.07 6.06M229.95 449.64v-9.22h-21.69v9.22h-3.88v-22.31h3.88v9.22h21.69v-9.22h3.89v22.31h-3.89zM286.91 427.33h3.88v22.31h-3.88zM369.45 431.21h-21.69v7.76h21.69v-7.76Zm-2.18 11.64h-19.51v6.79h-3.88v-22.31h23.39c3.36 0 6.07 2.71 6.07 6.06v3.39c0 3.36-2.71 6.06-6.07 6.06M451.99 431.21H430.3v7.76h21.69v-7.76Zm-2.19 11.64h-19.51v6.79h-3.88v-22.31h23.39c3.36 0 6.07 2.71 6.07 6.06v3.39c0 3.36-2.71 6.06-6.07 6.06M508.95 427.33h3.88v22.31h-3.88zM595.62 445.64c0 2.42-1.94 4.36-4.37 4.36-1.21 0-2.31-.48-3.11-1.29l-18.33-18.59v19.52h-3.88v-18.31c0-2.42 1.94-4.36 4.37-4.36 1.21 0 2.31.48 3.12 1.29l18.33 18.58v-19.51h3.89v18.3ZM672.09 449.64h-17.32c-3.36 0-6.07-2.71-6.07-6.06V433.4c0-3.36 2.71-6.06 6.07-6.06h23.39v3.88h-25.57v14.55h21.69v-5.34H662.9v-3.88h15.26v7.03c0 3.36-2.71 6.06-6.07 6.06" class="cls-1"/>
                </svg>
                <h1>Covalex Logistics <span style="font-size:0.5em; color:white; opacity:0.5;">// MANAGER V34</span></h1>
            </div>
            <div style="text-align:right;">
                <button class="btn btn-add" style="border-color:var(--sc-money); color:var(--sc-money);" onclick="exportReport()">EXPORT</button>
                <button class="btn btn-add" onclick="resetAllData()">RESET ALL</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="sidebar">
            <div class="panel">
                <h3>01 // Vessel & State</h3>
                <div style="background:rgba(0,0,0,0.3); padding:10px; margin-bottom:15px; border:1px solid #444;">
                    <label>Current Location</label>
                    <select id="currentLocationSelect" onchange="updateCurrentLocationOverride()"></select>
                    <div class="eng-stat-row" style="margin-top:5px;">
                        <span>Start Fuel (NAV Mode):</span>
                        <input type="number" id="currentFuelInput" value="8.60" step="0.01" style="width:80px; height:25px; padding:2px; color:var(--sc-fuel); border-color:var(--sc-fuel);" onchange="manualFuelUpdate()">
                    </div>
                </div>
                <label>Select Vessel</label>
                <select id="shipSelect" onchange="updateShip()">
                    <option value="4608">MISC Hull C (4608 SCU)</option>
                    <option value="2880">MISC Hull C - Safe Config (2880 SCU)</option>
                    <option value="custom">Custom Configuration...</option>
                </select>
                <div id="customShipInput" style="display:none;">
                    <input type="number" id="customCapacity" value="1000" placeholder="Custom SCU">
                </div>
                <label>Max Fuel Tank (SCU)</label>
                <input type="number" id="shipFuelCap" value="8.60" step="0.01">
                <div style="margin-top:15px; border-top:1px dashed #444; padding-top:10px;">
                    <h4 style="color:var(--sc-fuel); margin-bottom:5px;">Quantum Drive Calibration</h4>
                    <select id="qtDriveSelect" onchange="updateShip()">
                        <option value="kama" selected>Kama (Industrial C)</option>
                        <option value="pontes">Pontes (Industrial B)</option>
                        <option value="ts2">TS-2 (Military A)</option>
                    </select>
                    <div id="driveStats" style="margin-top:10px;">
                        <div class="eng-stat-row"><span>Calibrated Rate (mSCU/Gm)</span> <span id="dsEff" class="eng-val" style="color:var(--sc-fuel); font-weight:bold;">26.00</span></div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h3>02 // Add Contract</h3>
                
                <div style="display:flex; gap:5px; align-items:end; margin-bottom:5px;">
                    <div style="flex:2;">
                        <label>Autofill Template</label>
                        <select id="nameTemplate" onchange="applyTemplate()" style="margin-bottom:0;">
                            <option value="">-- Select Template --</option>
                            <option value="Experienced Rank - Direct Large Cargo Haul">Exp. Direct Large</option>
                            <option value="Experienced Rank - Large Cargo Haul">Exp. Large</option>
                            <option value="Senior Rank - Direct Large Cargo Haul">Senior Direct Large</option>
                            <option value="Senior Rank - Large Cargo Haul">Senior Large</option>
                            <option value="Master Rank - Direct Large Cargo Haul">Master Direct Large</option>
                            <option value="Master Rank - Large Cargo Haul">Master Large</option>
                        </select>
                    </div>
                </div>

                <label>Contract Name (Manual)</label>
                <input type="text" id="cName" placeholder="Enter name...">

                <label style="color:var(--sc-money);">Reward (aUEC)</label>
                <input type="number" id="cPrice" placeholder="0">

                <div class="section-header" style="margin-top:15px;">
                    <span style="font-size:0.8rem; color:#888;">PICKUP LOCATIONS (LINE ITEMS)</span>
                    <button id="btnAddPickup" class="btn btn-add" type="button">+ ADD PICKUP</button>
                </div>
                <div id="pickupContainer"></div>

                <div class="section-header" style="margin-top:15px;">
                    <span style="font-size:0.8rem; color:#888;">DROP-OFF LOCATIONS (LINE ITEMS)</span>
                    <button id="btnAddDrop" class="btn btn-add" type="button">+ ADD DROP</button>
                </div>
                <div id="dropContainer"></div>

                <div id="statusLog"></div>
                <button id="btnSubmit" class="btn" type="button">ADD TO MANIFEST</button>
                <button id="btnLoadDemo" class="btn" type="button" style="border-color:#555; color:#888; margin-top:5px;">LOAD DEMO</button>
            </div>
        </div>

        <div class="main-content">
            <div class="panel" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; text-align:center;">
                <div><h4 style="margin:0; color:#888;">REALIZED EARNINGS</h4><span id="moneyEarned" style="font-size:1.5rem; font-weight:bold; color:var(--sc-money);">0 aUEC</span></div>
                <div><h4 style="margin:0; color:#888;">POTENTIAL REMAINING</h4><span id="moneyPotential" style="font-size:1.5rem; font-weight:bold; color:#fff;">0 aUEC</span></div>
            </div>
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:end;"><h4 style="margin:0; color:#888;">CARGO LOAD</h4><span id="capacityText" style="margin:0; font-weight:bold;">0 / 4608 SCU</span></div>
                <div class="capacity-bar-container"><div id="fillBar" class="capacity-bar"></div></div>
                <div style="display:flex; justify-content:space-between; align-items:end;"><h4 style="margin:0; color:#888;">QUANTUM FUEL (SCU)</h4><span id="fuelText" style="margin:0; font-weight:bold; color:var(--sc-fuel);">8.60 / 8.60</span></div>
                <div class="capacity-bar-container"><div id="fuelBar" class="capacity-bar fuel-bar" style="width:100%;"></div></div>
            </div>
            <div class="panel">
                <div style="display:flex; justify-content:space-between; align-items:center;"><h3>Remaining Itinerary</h3><button class="btn btn-calc" style="width:auto; margin:0; padding:8px 20px;" onclick="calculateRoute()">Recalculate</button></div>
                <p style="font-size:0.8rem; color:#888; margin-bottom:20px;">Itinerary uses verified data where available ([V]). Estimates marked ([E]).</p>
                <div id="itineraryContent"></div>
            </div>
            <div class="panel">
                <h3>Active Contracts & Dev Feedback</h3>
                <div id="manifestList"><p style="color:#666; font-style:italic; padding:10px;">No active contracts.</p></div>
            </div>
            <div class="panel">
                <h3>Session Log</h3>
                <div id="sessionLog" style="max-height:200px; overflow-y:auto;">
                    <table class="log-table"><thead><tr><th>Action</th><th>Location</th><th>Change</th><th>Time</th></tr></thead><tbody id="logBody"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>This is an unofficial Star Citizen fan site.</p>
        <p>This content is not endorsed by or affiliated with Cloud Imperium or its licensors. Star Citizen¬Æ, Roberts Space Industries¬Æ, and Cloud Imperium¬Æ are registered trademarks of Cloud Imperium Rights LLC. All content on this site not authored by its host or users are property of their respective owners.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DATA: Locations & Graph
            const systemGraph = { "Stanton": ["Terra", "Pyro", "Nyx"], "Pyro": ["Stanton", "Nyx", "Castra"], "Nyx": ["Pyro", "Stanton"], "Castra": ["Pyro", "Terra"], "Terra": ["Stanton", "Castra"] };
            const locations = [
                // STANTON (System)
                { id:"hur", name: "Everus Harbor (Hurston)", system: "Stanton" }, 
                { id:"cru", name: "Seraphim Station (Crusader)", system: "Stanton" },
                { id:"arc", name: "Bajini Point (ArcCorp)", system: "Stanton" }, 
                { id:"mic", name: "Port Tressler (microTech)", system: "Stanton" },
                { id:"pyrg_st", name: "Pyro Gateway (Stanton)", system: "Stanton" },
                { id:"nyxg_st", name: "Nyx Gateway (Stanton)", system: "Stanton" },
                { id:"terg_st", name: "Terra Gateway (Stanton)", system: "Stanton" },

                // PYRO (System)
                { id:"pyr1", name: "Checkmate Station (Pyro I)", system: "Pyro" }, 
                { id:"pyr2", name: "Monox Station (Pyro II)", system: "Pyro" }, 
                { id:"stang_py", name: "Stanton Gateway (Pyro)", system: "Pyro" },
                { id:"nyxg_py", name: "Nyx Gateway (Pyro)", system: "Pyro" },
                { id:"casg_py", name: "Castra Gateway (Pyro)", system: "Pyro" },

                // NYX (System)
                { id:"nyx1", name: "Levski (Delamar)", system: "Nyx" }, 
                { id:"pyrg_ny", name: "Pyro Gateway (Nyx)", system: "Nyx" },
                { id:"stang_ny", name: "Stanton Gateway (Nyx)", system: "Nyx" },

                // CASTRA (System)
                { id:"cas1", name: "Sherman (Castra II)", system: "Castra" }, 
                { id:"pyrg_ca", name: "Pyro Gateway (Castra)", system: "Castra" },
                { id:"terg_ca", name: "Terra Gateway (Castra)", system: "Castra" },

                // TERRA (System)
                { id:"ter1", name: "Prime Orbital (Terra)", system: "Terra" }, 
                { id:"stang_te", name: "Stanton Gateway (Terra)", system: "Terra" },
                { id:"casg_te", name: "Castra Gateway (Terra)", system: "Terra" }
            ];
            
            const stantonDist = { "hur-cru": 32, "hur-arc": 22, "hur-mic": 59, "cru-arc": 42, "cru-mic": 58, "arc-mic": 59 };
            const baseDrives = { "kama": { speed: 319000, rate: 26.0, spool: 5.0 }, "pontes": { speed: 466000, rate: 39.5, spool: 4.5 }, "ts2": { speed: 590000, rate: 52.1, spool: 4.0 } };
            let commodityList = ["Hydrogen", "Iron", "Waste", "Scrap", "Processed Food", "Medical Supplies", "Corundum", "Beryl", "Quartz", "Tungsten", "Titanium", "Gold", "Diamond", "Laranite", "Agricium", "Quantanium"].sort();
            let locationOptionsHTML = ''; let commodityOptionsHTML = '';

            // STATE
            let appState = {
                shipCapacity: 4608, shipMaxFuelSCU: 8.6,
                currentDriveKey: 'kama', calibratedRate: 26.0, 
                currentLocation: "Everus Harbor (Hurston)", currentFuelSCU: 8.6, currentLoad: 0,
                contracts: [], completedLegs: [], earnings: 0, routeMemory: {}
            };

            // INIT
            loadData(); initUI(); updateUI();

            function saveData() { localStorage.setItem('covalex_v34_state', JSON.stringify(appState)); updateUI(); }
            function loadData() {
                const saved = localStorage.getItem('covalex_v34_state');
                if(saved) { 
                    appState = JSON.parse(saved); 
                    if(!appState.calibratedRate) appState.calibratedRate = 26.0; 
                    if(!appState.routeMemory) appState.routeMemory = {}; 
                    appState.contracts.forEach(c => { if(!c.feedback) c.feedback = { status: "pending", issues: [], notes: "" }; });
                }
            }
            window.resetAllData = function() { if(confirm("Clear all data?")) { localStorage.removeItem('covalex_v34_state'); location.reload(); } }

            // NAME HELPER
            window.applyTemplate = function() {
                const val = document.getElementById('nameTemplate').value;
                if(val) document.getElementById('cName').value = val;
            }

            // EXPORT
            window.exportReport = function() {
                const data = {
                    sessionTime: new Date().toString(),
                    shipConfig: { capacity: appState.shipCapacity, fuelMax: appState.shipMaxFuelSCU, drive: appState.currentDriveKey, calibratedEfficiency: appState.calibratedRate },
                    learnedRoutes: appState.routeMemory,
                    contracts: appState.contracts.map(c => ({ name: c.name, totalSCU: c.totalSCU, feedbackStatus: c.feedback.status, reportedIssues: c.feedback.issues, devNotes: c.feedback.notes })),
                    logs: appState.completedLegs
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = "Covalex_Report_" + Date.now() + ".json"; a.click();
            }

            // TOGGLE MANUAL
            window.toggleManual = function() {
                const drawer = document.getElementById('manualDrawer');
                const tab = document.getElementById('manualTab');
                if(drawer.classList.contains('active')) { drawer.classList.remove('active'); tab.classList.remove('active'); } else { drawer.classList.add('active'); tab.classList.add('active'); }
            }

            function initUI() {
                let opts = ''; const sysMap = {};
                locations.forEach(l => { if(!sysMap[l.system]) sysMap[l.system]=[]; sysMap[l.system].push(l.name); });
                for(let s in sysMap) { opts += `<optgroup label="${s}">${sysMap[s].map(n=>`<option value="${n}">${n}</option>`).join('')}</optgroup>`; }
                locationOptionsHTML = opts;
                document.getElementById('currentLocationSelect').innerHTML = opts;
                document.getElementById('currentLocationSelect').value = appState.currentLocation;
                
                let cOpts = '<option value="" disabled selected>Select Commodity...</option>';
                commodityList.forEach(c => cOpts += `<option value="${c}">${c}</option>`);
                commodityOptionsHTML = cOpts;

                document.getElementById('shipSelect').value = appState.shipCapacity === 4608 ? "4608" : (appState.shipCapacity===2880?"2880":"custom");
                if(document.getElementById('shipSelect').value==='custom') document.getElementById('customShipInput').style.display='block';
                document.getElementById('shipFuelCap').value = appState.shipMaxFuelSCU;
                document.getElementById('qtDriveSelect').value = appState.currentDriveKey;
                document.getElementById('currentFuelInput').value = appState.currentFuelSCU.toFixed(2);

                document.getElementById('shipSelect').addEventListener('change', updateShipConfig);
                document.getElementById('shipFuelCap').addEventListener('input', updateShipConfig);
                document.getElementById('qtDriveSelect').addEventListener('change', updateShipConfig);
                
                document.getElementById('btnAddPickup').addEventListener('click', ()=>addPointRow('pickupContainer'));
                document.getElementById('btnAddDrop').addEventListener('click', ()=>addPointRow('dropContainer'));
                document.getElementById('btnSubmit').addEventListener('click', addContract);
                document.getElementById('btnLoadDemo').addEventListener('click', loadDemoData);

                addPointRow('pickupContainer'); addPointRow('dropContainer');
                renderLogs();
            }

            function updateUI() {
                const drv = baseDrives[appState.currentDriveKey];
                const cal = appState.calibratedRate.toFixed(2);
                document.getElementById('dsEff').innerHTML = `${cal} <span style="font-size:0.7em; color:#666;">(Base: ${drv.rate})</span>`;
                document.getElementById('capacityText').innerText = `${appState.currentLoad} / ${appState.shipCapacity} SCU`;
                document.getElementById('fillBar').style.width = Math.min((appState.currentLoad/appState.shipCapacity)*100, 100) + "%";
                const fVal = appState.currentFuelSCU;
                const fMax = appState.shipMaxFuelSCU;
                document.getElementById('fuelText').innerText = `${fVal.toFixed(2)} / ${fMax.toFixed(2)} SCU`;
                document.getElementById('fuelBar').style.width = Math.min((fVal/fMax)*100, 100) + "%";
                let potential = 0;
                appState.contracts.forEach(c => { const remaining = c.totalSCU - c.droppedOff; if(remaining > 0) potential += (c.price || 0); });
                document.getElementById('moneyEarned').innerText = appState.earnings.toLocaleString() + " aUEC";
                document.getElementById('moneyPotential').innerText = potential.toLocaleString() + " aUEC";
                document.getElementById('currentLocationSelect').value = appState.currentLocation;
            }

            function updateShipConfig() {
                const sVal = document.getElementById('shipSelect').value;
                if(sVal === 'custom') { document.getElementById('customShipInput').style.display='block'; appState.shipCapacity = parseInt(document.getElementById('customCapacity').value) || 1000; } 
                else { document.getElementById('customShipInput').style.display='none'; appState.shipCapacity = parseInt(sVal); }
                appState.shipMaxFuelSCU = parseFloat(document.getElementById('shipFuelCap').value) || 8.6;
                appState.currentDriveKey = document.getElementById('qtDriveSelect').value;
                appState.currentFuelSCU = appState.shipMaxFuelSCU;
                document.getElementById('currentFuelInput').value = appState.currentFuelSCU.toFixed(2);
                saveData(); calculateRoute();
            }

            window.manualFuelUpdate = function() { appState.currentFuelSCU = parseFloat(document.getElementById('currentFuelInput').value); saveData(); calculateRoute(); }
            window.updateCurrentLocationOverride = function() { appState.currentLocation = document.getElementById('currentLocationSelect').value; saveData(); calculateRoute(); }

            function addPointRow(containerId) {
                const div = document.createElement('div'); div.className = 'dynamic-row-complex';
                div.innerHTML = `<div class="drc-top"><select class="loc-input" style="width:100%; font-weight:bold;">${locationOptionsHTML}</select></div><div class="drc-mid"><select class="comm-input" style="flex:2">${commodityOptionsHTML}</select><input type="number" class="scu-input" placeholder="SCU" style="flex:1"></div><div class="drc-bot"><button class="btn btn-del" onclick="this.parentElement.parentElement.remove()">-</button></div>`;
                document.getElementById(containerId).appendChild(div);
            }

            function addContract() {
                const name = document.getElementById('cName').value || "Contract";
                const price = parseInt(document.getElementById('cPrice').value) || 0;
                
                const getPoints = (id) => {
                    const rows = document.getElementById(id).querySelectorAll('.dynamic-row-complex');
                    let pts=[]; let t=0; let commMap={};
                    rows.forEach(r => {
                        const l=r.querySelector('.loc-input').value; const c=r.querySelector('.comm-input').value; const s=parseInt(r.querySelector('.scu-input').value);
                        if(l&&c&&s) { pts.push({location:l, commodity:c, amount:s}); t+=s; if(!commMap[c]) commMap[c]=0; commMap[c]+=s; }
                    });
                    return {pts, t, commMap};
                };
                const p = getPoints('pickupContainer'); const d = getPoints('dropContainer');
                if(p.t === 0 || d.t === 0) { alert("Add Pickups/Drops."); return; }
                if(p.t !== d.t) { if(!confirm(`Pickup Total (${p.t}) != Drop Total (${d.t}). Proceed?`)) return; }
                
                for(let comm in p.commMap) { if(p.commMap[comm] !== d.commMap[comm]) { if(!confirm(`Commodity Mismatch: ${comm}. Proceed?`)) return; } }
                let summaryComms = []; for(let comm in p.commMap) { summaryComms.push({name: comm, scu: p.commMap[comm]}); }

                appState.contracts.push({
                    id: Date.now(), name: name, commodities: summaryComms, price: price,
                    pickups: p.pts, drops: d.pts, totalSCU: p.t, pickedUp: 0, droppedOff: 0,
                    feedback: { status: "pending", issues: [], notes: "" }
                });
                
                document.getElementById('cName').value = ""; document.getElementById('cPrice').value = "";
                document.getElementById('pickupContainer').innerHTML = ""; document.getElementById('dropContainer').innerHTML = "";
                addPointRow('pickupContainer'); addPointRow('dropContainer');
                appState.completedLegs.push({action:"CONTRACT", location:"-", desc:`Added ${name}`, time: new Date().toLocaleTimeString()});
                saveData(); renderLogs(); renderManifest(); calculateRoute();
            }

            window.toggleFeedback = function(id) { const drawer = document.getElementById('feedback-' + id); drawer.style.display = drawer.style.display === 'block' ? 'none' : 'block'; }
            window.updateFeedback = function(id, field, value) { const c = appState.contracts.find(ctr => ctr.id === id); if(c) { if(field === 'issue') { const idx = c.feedback.issues.indexOf(value); if(idx > -1) c.feedback.issues.splice(idx, 1); else c.feedback.issues.push(value); } else { c.feedback[field] = value; } saveData(); } }
            
            function renderManifest() {
                const listEl = document.getElementById('manifestList'); listEl.innerHTML = "";
                appState.contracts.forEach(c => {
                    let commsHtml = ""; c.commodities.forEach(cm => { commsHtml += `<span class="comm-pill">${cm.scu} ${cm.name}</span>`; });
                    if(!c.feedback) c.feedback = { status: "pending", issues: [], notes: "" };
                    const isChecked = (val) => c.feedback.issues.includes(val) ? 'checked' : '';
                    const div = document.createElement('div'); div.className = 'contract-card';
                    div.innerHTML = `<div><div style="display:flex; justify-content:space-between; align-items:center;"><strong>${c.name}</strong><button class="btn-log" onclick="toggleFeedback(${c.id})">üìù LOG</button></div><div style="margin-top:5px;">${commsHtml}</div><div id="feedback-${c.id}" class="feedback-drawer"><label>Completion</label><select onchange="updateFeedback(${c.id}, 'status', this.value)"><option value="pending" ${c.feedback.status==='pending'?'selected':''}>Pending</option><option value="success" ${c.feedback.status==='success'?'selected':''}>Success</option><option value="partial" ${c.feedback.status==='partial'?'selected':''}>Partial</option><option value="failed" ${c.feedback.status==='failed'?'selected':''}>Failed</option></select><label>Bugs</label><div class="check-group"><label class="check-item"><input type="checkbox" onchange="updateFeedback(${c.id}, 'issue', 'chair_glitch')" ${isChecked('chair_glitch')}> Chair Glitch</label><label class="check-item"><input type="checkbox" onchange="updateFeedback(${c.id}, 'issue', 'docking_fail')" ${isChecked('docking_fail')}> Docking Bug</label></div><label>Notes</label><textarea onchange="updateFeedback(${c.id}, 'notes', this.value)">${c.feedback.notes}</textarea></div></div><div style="text-align:right; margin-left:10px;"><b>${c.totalSCU} SCU</b><br><span style="color:var(--sc-money); font-size:0.8rem;">${c.price.toLocaleString()} aUEC</span><br><button class="btn btn-del" style="width:auto; height:20px; font-size:0.7rem;" onclick="removeContract(${c.id})">Remove</button></div>`;
                    listEl.appendChild(div);
                });
            }

            function renderLogs() { const tbody = document.getElementById('logBody'); tbody.innerHTML = ""; [...appState.completedLegs].reverse().forEach(log => { tbody.innerHTML += `<tr><td>${log.action}</td><td>${log.location}</td><td>${log.desc}</td><td>${log.time}</td></tr>`; }); }
            function loadDemoData() { appState.currentLocation = "Everus Harbor (Hurston)"; appState.currentLoad = 0; appState.currentFuelSCU = 2.50; document.getElementById('currentFuelInput').value = "2.50"; let p1 = [{location:"Everus Harbor (Hurston)", commodity:"Iron", amount:500}, {location:"Everus Harbor (Hurston)", commodity:"Gold", amount:500}]; let d1 = [{location:"Port Tressler (microTech)", commodity:"Iron", amount:500}, {location:"Port Tressler (microTech)", commodity:"Gold", amount:500}]; appState.contracts = [ { id: 1, name: "Experienced Rank - Direct Large Cargo Haul", commodities:[{name:"Iron", scu:500}, {name:"Gold", scu:500}], price: 50000, totalSCU: 1000, pickups:p1, drops:d1, pickedUp:0, droppedOff:0, feedback: { status: "pending", issues: [], notes: "" } } ]; saveData(); renderManifest(); calculateRoute(); }
            window.removeContract = function(id) { appState.contracts = appState.contracts.filter(c => c.id !== id); saveData(); renderManifest(); calculateRoute(); };

            function getRouteKey(a, b) { return a < b ? `${a}_${b}` : `${b}_${a}`; }
            function getTravelMetrics(locNameA, locNameB) {
                if (locNameA === locNameB) return { jumps:0, distGm:0, isVerified:true };
                const key = getRouteKey(locNameA, locNameB);
                if (appState.routeMemory[key]) return { jumps: 0, distGm: appState.routeMemory[key].dist, isVerified: true };
                const locA = locations.find(l => l.name === locNameA); const locB = locations.find(l => l.name === locNameB);
                if (!locA || !locB) return { jumps:99, distGm:9999, isVerified:false };
                if (locA.system === locB.system) {
                    if(locA.system === "Stanton") {
                        const k1 = locA.id + "-" + locB.id; const k2 = locB.id + "-" + locA.id;
                        if(stantonDist[k1]) return { jumps:0, distGm: stantonDist[k1], isVerified:false };
                        if(stantonDist[k2]) return { jumps:0, distGm: stantonDist[k2], isVerified:false };
                        return { jumps:0, distGm: 45, isVerified:false };
                    }
                    if(locA.system === "Pyro") return { jumps:0, distGm: 80, isVerified:false };
                    return { jumps:0, distGm: 50, isVerified:false };
                }
                const result = findShortestPath(locA.system, locB.system);
                if (!result) return { jumps:99, distGm:9999, isVerified:false };
                return { jumps: result.jumps, distGm: result.jumps * 100, isVerified:false };
            }

            function findShortestPath(startSys, endSys) {
                if (startSys === endSys) return { jumps: 0 };
                let queue = [[startSys, 0]]; let visited = new Set(); visited.add(startSys);
                while (queue.length > 0) {
                    let [current, dist] = queue.shift();
                    if (current === endSys) return { jumps: dist };
                    const neighbors = systemGraph[current] || [];
                    for (let n of neighbors) { if (!visited.has(n)) { visited.add(n); queue.push([n, dist + 1]); } }
                }
                return null;
            }

            window.calculateRoute = function() {
                const el = document.getElementById('itineraryContent'); el.innerHTML = "Calculating...";
                let simState = JSON.parse(JSON.stringify(appState.contracts));
                let currentLoc = appState.currentLocation; let currentLoad = appState.currentLoad; let currentFuelSCU = appState.currentFuelSCU;
                let steps = []; let drive = baseDrives[appState.currentDriveKey]; const rate = appState.calibratedRate;
                let allTasks = [];
                simState.forEach((c, idx) => {
                    let pickedSoFar = c.pickedUp;
                    c.pickups.forEach(p => { let amt = p.amount; if(pickedSoFar >= amt) { pickedSoFar -= amt; } else { let rem = amt - pickedSoFar; pickedSoFar = 0; if(rem > 0) allTasks.push({type:'LOAD', cIdx:idx, loc:p.location, comm:p.commodity, amt:rem, done:false}); } });
                    let droppedSoFar = c.droppedOff;
                    c.drops.forEach(d => { let amt = d.amount; if(droppedSoFar >= amt) { droppedSoFar -= amt; } else { let rem = amt - droppedSoFar; droppedSoFar = 0; if(rem > 0) allTasks.push({type:'UNLOAD', cIdx:idx, loc:d.location, comm:d.commodity, amt:rem, done:false}); } });
                });

                let safety = 0;
                while(safety++ < 100) {
                    const pending = allTasks.filter(t => !t.done); if(pending.length === 0) break;
                    let bestTask = null, bestScore = -Infinity;
                    pending.forEach(task => {
                        let score = 0; let isValid = false; const c = simState[task.cIdx];
                        if (task.type === 'LOAD') { if (currentLoad + task.amt <= appState.shipCapacity) isValid = true; }
                        else { let simPicked = c.pickedUp; let simDropped = c.droppedOff; if ((simPicked - simDropped) >= task.amt) isValid = true; }
                        if(isValid) {
                            const metrics = getTravelMetrics(currentLoc, task.loc);
                            score -= metrics.distGm; score -= metrics.jumps * 50;
                            if(task.loc === currentLoc) score += 1000;
                            if(task.type === 'UNLOAD') { score += 20; if(currentLoad < (appState.shipCapacity*0.5) && task.loc !== currentLoc) score -= 100; }
                            if(task.type === 'LOAD') { score += 10; if(metrics.distGm < 30) score += 50; }
                            if(score > bestScore) { bestScore = score; bestTask = task; }
                        }
                    });
                    if(!bestTask) break;
                    bestTask.done = true;
                    if(bestTask.type==='LOAD') { currentLoad += bestTask.amt; simState[bestTask.cIdx].pickedUp += bestTask.amt; }
                    else { currentLoad -= bestTask.amt; simState[bestTask.cIdx].droppedOff += bestTask.amt; }
                    
                    const metrics = getTravelMetrics(currentLoc, bestTask.loc);
                    const distFuel_mSCU = metrics.distGm * rate; const jumpFuel_mSCU = metrics.jumps * 200; 
                    const fuelNeededSCU = (distFuel_mSCU + jumpFuel_mSCU) / 1000;
                    
                    let refueled = false;
                    if(currentLoc !== bestTask.loc && currentFuelSCU < fuelNeededSCU) {
                        currentFuelSCU = appState.shipMaxFuelSCU; refueled = true;
                        if(steps.length>0) steps[steps.length-1].refueled = true; else steps.push({loc:currentLoc, refueled:true, actions:[], endLoad:currentLoad, endFuel:currentFuelSCU}); 
                    }
                    if(currentLoc !== bestTask.loc) {
                        currentFuelSCU -= fuelNeededSCU; if(currentFuelSCU<0)currentFuelSCU=0;
                        steps.push({ loc: bestTask.loc, isTravel: true, dist: metrics.distGm, verified: metrics.isVerified, fuel: fuelNeededSCU, actions: [bestTask], endLoad: currentLoad, endFuel: currentFuelSCU });
                    } else {
                        if(steps.length===0) steps.push({loc:currentLoc, actions:[], endLoad:currentLoad, endFuel:currentFuelSCU});
                        steps[steps.length-1].actions.push(bestTask); steps[steps.length-1].endLoad = currentLoad;
                    }
                    currentLoc = bestTask.loc;
                }

                let html = "";
                steps.forEach((step, idx) => {
                    let actionsHtml = "";
                    step.actions.forEach(a => { const color = a.type === 'LOAD' ? 'var(--sc-success)' : 'var(--sc-warning)'; actionsHtml += `<div class="step-action"><span><strong style="color:${color}">${a.type}</strong> ${a.amt} SCU ${a.comm}</span></div>`; });
                    const isNext = (idx === 0);
                    let completeUI = isNext ? `<div style="display:flex; justify-content:flex-end; gap:5px; margin-top:5px;"><div class="fuel-input-row" title="HUD Fuel Reading"><span style="font-size:0.7rem; color:#888;">HUD (NAV Mode):</span><input type="number" id="stepFuelInput_${idx}" step="0.01" placeholder="${step.endFuel.toFixed(2)}"></div><button class="btn-complete" onclick='commitStep(${JSON.stringify(step)}, "stepFuelInput_${idx}")'>COMPLETE LEG</button></div>` : `<span style="color:#666; font-size:0.7rem; float:right;">PENDING</span>`;
                    
                    let vTag = step.verified ? '<span class="stat-badge badge-verified">[V]</span>' : '<span class="stat-badge badge-estimate">[E]</span>';
                    let distHtml = step.isTravel ? `<div class="step-distance">${vTag} Travel: ${step.dist.toFixed(1)} Gm</div>` : `<div class="step-distance">Local Operation</div>`;
                    if(step.refueled) distHtml = `<div class="step-refuel">‚õΩ AUTO-REFUELED</div>` + distHtml;
                    html += `<div class="timeline-step"><div class="step-location"><span>${step.loc}</span></div>${distHtml}${actionsHtml}<div class="step-ship-load">Load: ${step.endLoad} SCU | Est: ${step.endFuel.toFixed(2)} SCU</div>${completeUI}</div>`;
                });
                if(steps.length === 0) html = `<div style="padding:10px; color:var(--sc-success);">ALL CONTRACTS COMPLETED.</div>`;
                el.innerHTML = html;
            }

            window.commitStep = function(stepData, inputId) {
                const inputEl = document.getElementById(inputId); const actualFuel = parseFloat(inputEl.value);
                if (stepData.isTravel && !isNaN(actualFuel)) {
                    let startFuel = appState.currentFuelSCU; if(stepData.refueled) startFuel = appState.shipMaxFuelSCU;
                    const fuelUsedSCU = startFuel - actualFuel;
                    if (fuelUsedSCU > 0) {
                        const impliedDist = (fuelUsedSCU * 1000) / appState.calibratedRate;
                        const key = getRouteKey(appState.currentLocation, stepData.loc);
                        if(!appState.routeMemory[key]) appState.routeMemory[key] = { dist: impliedDist, count: 1 };
                        else { const m = appState.routeMemory[key]; m.dist = (m.dist * m.count + impliedDist) / (m.count + 1); m.count++; }
                        appState.completedLegs.push({action: "LEARNING", location: "NavComp", desc: `Route Updated: ${key} ~${impliedDist.toFixed(1)}Gm`, time: new Date().toLocaleTimeString()});
                    }
                    appState.currentFuelSCU = actualFuel;
                } else {
                    if(stepData.refueled) appState.currentFuelSCU = appState.shipMaxFuelSCU - (stepData.fuel || 0); else appState.currentFuelSCU = stepData.endFuel;
                }
                document.getElementById('currentFuelInput').value = appState.currentFuelSCU.toFixed(2);
                appState.currentLocation = stepData.loc; appState.currentLoad = stepData.endLoad;
                stepData.actions.forEach(a => {
                    const c = appState.contracts.find(ct => ct.id === appState.contracts[a.cIdx].id);
                    if(a.type === 'LOAD') c.pickedUp += a.amt;
                    if(a.type === 'UNLOAD') {
                        c.droppedOff += a.amt;
                        if(c.droppedOff >= c.totalSCU) { appState.earnings += c.price; appState.completedLegs.push({action:"PAYDAY", location:stepData.loc, desc:`Earned ${c.price} aUEC`, time:new Date().toLocaleTimeString()}); }
                    }
                });
                appState.completedLegs.push({action: stepData.isTravel ? "TRAVEL" : "OPS", location: stepData.loc, desc: `${stepData.actions.length} Actions`, time: new Date().toLocaleTimeString()});
                saveData(); updateUI(); renderLogs(); calculateRoute();
            }
        });
    </script>
</body>
</html>

